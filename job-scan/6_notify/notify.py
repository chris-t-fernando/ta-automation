from pushover import init, Client
import boto3


def lambda_handler(event, context):
    report_string = f'Symbol: {event["Payload"]["job"]["symbol"]}\n'
    report_string += f'Date from: {event["Payload"]["job"]["date_from"]}\n'
    report_string += f'Date to: {event["Payload"]["job"]["date_to"]}\n'
    report_string += (
        f'TA signal search: Last {event["Payload"]["job"]["search_period"]} quotes\n'
    )
    report_string += f'Minimum signal confidence: {event["Payload"]["job"]["target_ta_confidence"]}\n'
    report_string += f'Quote resolution: {event["Payload"]["job"]["resolution"]}\n'
    report_string += f"\n"

    for analysis in event["Payload"]["ta_analyses"]:
        for algo_name in analysis["ta_algo"]:
            # get the parameters handed to the algo
            parameters = []
            if analysis["ta_algo"][algo_name] == None:
                report_string += f"TA algo: {algo_name}\n"
            else:
                for parameter_key in analysis["ta_algo"][algo_name]:
                    parameters.append(
                        f'{parameter_key}: {analysis["ta_algo"][algo_name][parameter_key]}'
                    )
                report_string += f'TA algo: {algo_name} ({", ".join(parameters)})\n'

            report_string += (
                f'Signal confidence: {analysis["ta_analysis"]["confidence"]}\n'
            )
            report_string += f'Graph: {analysis["graph_url"]}\n'
            report_string += f"\n"

    ssm = boto3.client("ssm", region_name="ap-southeast-2")

    try:
        pushover_api_key = (
            ssm.get_parameter(Name="/tabot/pushover/api_key", WithDecryption=False)
            .get("Parameter")
            .get("Value")
        )

        pushover_user_key = (
            ssm.get_parameter(Name="/tabot/pushover/user_key", WithDecryption=False)
            .get("Parameter")
            .get("Value")
        )

    except Exception as e:
        print(f"Failed to retrieve Pushover config.  Error: {str(e)}")
        raise e

    init(pushover_api_key)
    Client(pushover_user_key).send_message(
        report_string,
        title=f'Technical analysis for {event["Payload"]["job"]["symbol"]} complete',
    )

    return True


if __name__ == "__main__":
    payload = {}
    payload["Payload"] = {
        "job": {
            "symbol": "bhp",
            "date_from": "2022-01-01T04:16:13+10:00",
            "date_to": "2022-03-30T04:16:13+10:00",
            "ta_algo": {
                "awesome-oscillator": {"strategy": "saucer", "direction": "bullish"}
            },
            "resolution": "1d",
            "search_period": 20,
            "notify_method": "pushover",
            "notify_recipient": "some-pushover-app-1",
            "target_ta_confidence": 3,
        },
        "ta_summary": {"overall_ta_confidence": 10, "target_ta_confidence": 3},
        "symbol_data": {
            "Open": {
                "1641168000000": 57.9464594475,
                "1641254400000": 57.8890743756,
                "1641340800000": 59.0462858116,
                "1641427200000": 59.5627213523,
                "1641513600000": 60.1461101493,
                "1641772800000": 60.3852020181,
                "1641859200000": 60.2513107736,
                "1641945600000": 64.0767884056,
                "1642032000000": 64.0767887775,
                "1642118400000": 63.35951573,
                "1642464000000": 63.9524660194,
                "1642550400000": 64.8418861535,
                "1642636800000": 65.5017808365,
                "1642723200000": 62.8430724822,
                "1642982400000": 60.4712736174,
                "1643068800000": 60.9685854639,
                "1643155200000": 61.5997932934,
                "1643241600000": 62.1353607676,
                "1643328000000": 61.7336874217,
                "1643587200000": 60.9685874218,
                "1643673600000": 61.1885521069,
                "1643760000000": 62.4413968703,
                "1643846400000": 63.6272944924,
                "1643932800000": 62.9769616596,
                "1644192000000": 64.6314866309,
                "1644278400000": 66.2955706485,
                "1644364800000": 65.4443953412,
                "1644451200000": 66.7068066545,
                "1644537600000": 65.5687223174,
                "1644796800000": 65.6069768546,
                "1644883200000": 64.1246089262,
                "1644969600000": 64.5071558408,
                "1645056000000": 65.1766180946,
                "1645142400000": 66.3433868642,
                "1645488000000": 66.3816487235,
                "1645574400000": 66.6494265131,
                "1645660800000": 63.5400009155,
                "1645747200000": 64.2900009155,
                "1646006400000": 66.9700012207,
                "1646092800000": 68.0899963379,
                "1646179200000": 71.0699996948,
                "1646265600000": 72.4899978638,
                "1646352000000": 70.7900009155,
                "1646611200000": 72.7099990845,
                "1646697600000": 69.5800018311,
                "1646784000000": 68.7600021362,
                "1646870400000": 69.8600006104,
                "1646956800000": 68.4199981689,
                "1647216000000": 67,
                "1647302400000": 63.9599990845,
                "1647388800000": 65.4599990845,
                "1647475200000": 66.5500030518,
                "1647561600000": 68.7699966431,
                "1647820800000": 70.4199981689,
                "1647907200000": 72.6399993896,
                "1647993600000": 71.6100006104,
                "1648080000000": 73.6900024414,
                "1648166400000": 74.2399978638,
                "1648425600000": 75.7900009155,
                "1648512000000": 74.25,
            },
            "High": {
                "1641168000000": 58.1281684373,
                "1641254400000": 58.9506456491,
                "1641340800000": 60.2321825767,
                "1641427200000": 59.9070151298,
                "1641513600000": 61.5615409935,
                "1641772800000": 60.6816780354,
                "1641859200000": 61.7910670771,
                "1641945600000": 64.2871909678,
                "1642032000000": 64.5740979576,
                "1642118400000": 64.2967615882,
                "1642464000000": 64.5932321832,
                "1642550400000": 65.78869037,
                "1642636800000": 66.5250964693,
                "1642723200000": 63.2064904592,
                "1642982400000": 61.8101894053,
                "1643068800000": 61.6762971973,
                "1643155200000": 62.5944116416,
                "1643241600000": 63.2064905099,
                "1643328000000": 61.8293229639,
                "1643587200000": 60.9685874218,
                "1643673600000": 62.2309955519,
                "1643760000000": 62.9195818603,
                "1643846400000": 63.6368602353,
                "1643932800000": 63.5316579986,
                "1644192000000": 65.8556390688,
                "1644278400000": 66.3433920689,
                "1644364800000": 66.008650104,
                "1644451200000": 67.844889275,
                "1644537600000": 66.3625111377,
                "1644796800000": 65.6069768546,
                "1644883200000": 64.6123523538,
                "1644969600000": 65.8652068338,
                "1645056000000": 65.5687260072,
                "1645142400000": 66.5250921952,
                "1645488000000": 66.7928808406,
                "1645574400000": 66.7737519843,
                "1645660800000": 63.8100013733,
                "1645747200000": 67.0699996948,
                "1646006400000": 68.0699996948,
                "1646092800000": 68.9599990845,
                "1646179200000": 71.9800033569,
                "1646265600000": 73.5800018311,
                "1646352000000": 73.1399993896,
                "1646611200000": 73.2300033569,
                "1646697600000": 70.6999969482,
                "1646784000000": 70.1999969482,
                "1646870400000": 71.25,
                "1646956800000": 69.6200027466,
                "1647216000000": 67.2200012207,
                "1647302400000": 64.8199996948,
                "1647388800000": 66.9700012207,
                "1647475200000": 67.9400024414,
                "1647561600000": 68.9100036621,
                "1647820800000": 72.0999984741,
                "1647907200000": 73,
                "1647993600000": 72.9899978638,
                "1648080000000": 74.5800018311,
                "1648166400000": 75.3899993896,
                "1648425600000": 75.8700027466,
                "1648512000000": 75.7600021362,
            },
            "Low": {
                "1641168000000": 57.5160922104,
                "1641254400000": 57.8030009305,
                "1641340800000": 59.0271579736,
                "1641427200000": 58.7211183943,
                "1641513600000": 60.0696024446,
                "1641772800000": 59.4862155195,
                "1641859200000": 59.7348700913,
                "1641945600000": 63.2160539677,
                "1642032000000": 63.8855176998,
                "1642118400000": 63.2064930198,
                "1642464000000": 63.1969328262,
                "1642550400000": 64.6984292003,
                "1642636800000": 64.9566502152,
                "1642723200000": 62.1162292315,
                "1642982400000": 59.5053415393,
                "1643068800000": 60.1174167761,
                "1643155200000": 61.217243846,
                "1643241600000": 62.0684151587,
                "1643328000000": 60.4617135498,
                "1643587200000": 60.0982908688,
                "1643673600000": 61.045098796,
                "1643760000000": 61.9823360694,
                "1643846400000": 62.5944131484,
                "1643932800000": 62.7761248396,
                "1644192000000": 64.1341701427,
                "1644278400000": 64.9279612042,
                "1644364800000": 64.8036292321,
                "1644451200000": 66.5824811828,
                "1644537600000": 65.3678855008,
                "1644796800000": 64.583661304,
                "1644883200000": 63.1969288949,
                "1644969600000": 64.5071558408,
                "1645056000000": 64.6410459236,
                "1645142400000": 65.6069779077,
                "1645488000000": 65.1861861601,
                "1645574400000": 65.6739250435,
                "1645660800000": 62.2700004578,
                "1645747200000": 64.0899963379,
                "1646006400000": 66.9199981689,
                "1646092800000": 67.5699996948,
                "1646179200000": 70.6600036621,
                "1646265600000": 72.2900009155,
                "1646352000000": 70.7699966431,
                "1646611200000": 71.6800003052,
                "1646697600000": 69.0500030518,
                "1646784000000": 68.3799972534,
                "1646870400000": 69.4700012207,
                "1646956800000": 68.3499984741,
                "1647216000000": 65.0400009155,
                "1647302400000": 63.3699989319,
                "1647388800000": 65.3099975586,
                "1647475200000": 66.0699996948,
                "1647561600000": 67.6699981689,
                "1647820800000": 70.3700027466,
                "1647907200000": 70.6299972534,
                "1647993600000": 71.4400024414,
                "1648080000000": 73.6500015259,
                "1648166400000": 74.2399978638,
                "1648425600000": 74.6200027466,
                "1648512000000": 73.4700012207,
            },
            "Close": {
                "1641168000000": 57.7073669434,
                "1641254400000": 58.6446075439,
                "1641340800000": 59.3427581787,
                "1641427200000": 59.409702301,
                "1641513600000": 61.5519752502,
                "1641772800000": 60.3947677612,
                "1641859200000": 61.6763000488,
                "1641945600000": 64.2202453613,
                "1642032000000": 64.1724243164,
                "1642118400000": 64.0481033325,
                "1642464000000": 63.5507850647,
                "1642550400000": 65.4922180176,
                "1642636800000": 65.0618515015,
                "1642723200000": 62.1353607178,
                "1642982400000": 61.7910652161,
                "1643068800000": 61.0929145813,
                "1643155200000": 61.6571731567,
                "1643241600000": 62.9291496277,
                "1643328000000": 61.370262146,
                "1643587200000": 60.8251304626,
                "1643673600000": 62.1831741333,
                "1643760000000": 62.6613578796,
                "1643846400000": 62.871761322,
                "1643932800000": 63.2734413147,
                "1644192000000": 65.4635238647,
                "1644278400000": 66.1425552368,
                "1644364800000": 65.8938903809,
                "1644451200000": 66.8885192871,
                "1644537600000": 65.9034576416,
                "1644796800000": 65.2818145752,
                "1644883200000": 64.5740966797,
                "1644969600000": 65.7313156128,
                "1645056000000": 64.9566497803,
                "1645142400000": 66.3146896362,
                "1645488000000": 65.7408752441,
                "1645574400000": 65.7600021362,
                "1645660800000": 63.5,
                "1645747200000": 67.0599975586,
                "1646006400000": 67.7900009155,
                "1646092800000": 68.5,
                "1646179200000": 71.9700012207,
                "1646265600000": 73,
                "1646352000000": 73.1200027466,
                "1646611200000": 72.4000015259,
                "1646697600000": 69.5699996948,
                "1646784000000": 69.8399963379,
                "1646870400000": 71.2099990845,
                "1646956800000": 68.5500030518,
                "1647216000000": 65.4899978638,
                "1647302400000": 64.7799987793,
                "1647388800000": 66.8399963379,
                "1647475200000": 67.9000015259,
                "1647561600000": 68.8000030518,
                "1647820800000": 71.6399993896,
                "1647907200000": 71.0299987793,
                "1647993600000": 72.9599990845,
                "1648080000000": 74.2699966431,
                "1648166400000": 75.3399963379,
                "1648425600000": 75.5899963379,
                "1648512000000": 75.6299972534,
            },
            "Volume": {
                "1641168000000": 1584400,
                "1641254400000": 3321300,
                "1641340800000": 6382600,
                "1641427200000": 2926300,
                "1641513600000": 3727700,
                "1641772800000": 4356900,
                "1641859200000": 4215000,
                "1641945600000": 4599500,
                "1642032000000": 5200900,
                "1642118400000": 5379300,
                "1642464000000": 6245200,
                "1642550400000": 4511700,
                "1642636800000": 8650500,
                "1642723200000": 9531000,
                "1642982400000": 7971000,
                "1643068800000": 7583800,
                "1643155200000": 6814500,
                "1643241600000": 10163300,
                "1643328000000": 12077100,
                "1643587200000": 8622300,
                "1643673600000": 9333000,
                "1643760000000": 7129300,
                "1643846400000": 11194000,
                "1643932800000": 6727600,
                "1644192000000": 6401300,
                "1644278400000": 9667500,
                "1644364800000": 9618900,
                "1644451200000": 7782400,
                "1644537600000": 5308100,
                "1644796800000": 6593500,
                "1644883200000": 6880200,
                "1644969600000": 6314300,
                "1645056000000": 6195500,
                "1645142400000": 6099500,
                "1645488000000": 4544600,
                "1645574400000": 5315800,
                "1645660800000": 6531000,
                "1645747200000": 5642500,
                "1646006400000": 3760700,
                "1646092800000": 4749600,
                "1646179200000": 5204000,
                "1646265600000": 5053500,
                "1646352000000": 5597600,
                "1646611200000": 6735300,
                "1646697600000": 7243600,
                "1646784000000": 9496000,
                "1646870400000": 5434800,
                "1646956800000": 4715600,
                "1647216000000": 6665200,
                "1647302400000": 5259200,
                "1647388800000": 5112200,
                "1647475200000": 3809300,
                "1647561600000": 4456000,
                "1647820800000": 5374900,
                "1647907200000": 6015800,
                "1647993600000": 3804800,
                "1648080000000": 3553600,
                "1648166400000": 2933500,
                "1648425600000": 5575500,
                "1648512000000": 4375200,
            },
            "Dividends": {
                "1641168000000": 0,
                "1641254400000": 0,
                "1641340800000": 0,
                "1641427200000": 0,
                "1641513600000": 0,
                "1641772800000": 0,
                "1641859200000": 0,
                "1641945600000": 0,
                "1642032000000": 0,
                "1642118400000": 0,
                "1642464000000": 0,
                "1642550400000": 0,
                "1642636800000": 0,
                "1642723200000": 0,
                "1642982400000": 0,
                "1643068800000": 0,
                "1643155200000": 0,
                "1643241600000": 0,
                "1643328000000": 0,
                "1643587200000": 0,
                "1643673600000": 0,
                "1643760000000": 0,
                "1643846400000": 0,
                "1643932800000": 0,
                "1644192000000": 0,
                "1644278400000": 0,
                "1644364800000": 0,
                "1644451200000": 0,
                "1644537600000": 0,
                "1644796800000": 0,
                "1644883200000": 0,
                "1644969600000": 0,
                "1645056000000": 0,
                "1645142400000": 0,
                "1645488000000": 0,
                "1645574400000": 0,
                "1645660800000": 3,
                "1645747200000": 0,
                "1646006400000": 0,
                "1646092800000": 0,
                "1646179200000": 0,
                "1646265600000": 0,
                "1646352000000": 0,
                "1646611200000": 0,
                "1646697600000": 0,
                "1646784000000": 0,
                "1646870400000": 0,
                "1646956800000": 0,
                "1647216000000": 0,
                "1647302400000": 0,
                "1647388800000": 0,
                "1647475200000": 0,
                "1647561600000": 0,
                "1647820800000": 0,
                "1647907200000": 0,
                "1647993600000": 0,
                "1648080000000": 0,
                "1648166400000": 0,
                "1648425600000": 0,
                "1648512000000": 0,
            },
            "Stock Splits": {
                "1641168000000": 0,
                "1641254400000": 0,
                "1641340800000": 0,
                "1641427200000": 0,
                "1641513600000": 0,
                "1641772800000": 0,
                "1641859200000": 0,
                "1641945600000": 0,
                "1642032000000": 0,
                "1642118400000": 0,
                "1642464000000": 0,
                "1642550400000": 0,
                "1642636800000": 0,
                "1642723200000": 0,
                "1642982400000": 0,
                "1643068800000": 0,
                "1643155200000": 0,
                "1643241600000": 0,
                "1643328000000": 0,
                "1643587200000": 0,
                "1643673600000": 0,
                "1643760000000": 0,
                "1643846400000": 0,
                "1643932800000": 0,
                "1644192000000": 0,
                "1644278400000": 0,
                "1644364800000": 0,
                "1644451200000": 0,
                "1644537600000": 0,
                "1644796800000": 0,
                "1644883200000": 0,
                "1644969600000": 0,
                "1645056000000": 0,
                "1645142400000": 0,
                "1645488000000": 0,
                "1645574400000": 0,
                "1645660800000": 0,
                "1645747200000": 0,
                "1646006400000": 0,
                "1646092800000": 0,
                "1646179200000": 0,
                "1646265600000": 0,
                "1646352000000": 0,
                "1646611200000": 0,
                "1646697600000": 0,
                "1646784000000": 0,
                "1646870400000": 0,
                "1646956800000": 0,
                "1647216000000": 0,
                "1647302400000": 0,
                "1647388800000": 0,
                "1647475200000": 0,
                "1647561600000": 0,
                "1647820800000": 0,
                "1647907200000": 0,
                "1647993600000": 0,
                "1648080000000": 0,
                "1648166400000": 0,
                "1648425600000": 0,
                "1648512000000": 0,
            },
        },
        "ta_analyses": [
            {
                "symbol": "bhp",
                "date_from": "2022-01-01T04:16:13+10:00",
                "date_to": "2022-03-30T04:16:13+10:00",
                "resolution": "1d",
                "search_period": 20,
                "notify_method": "pushover",
                "notify_recipient": "some-pushover-app-1",
                "target_ta_confidence": 3,
                "ta_algo": {
                    "awesome-oscillator": {"strategy": "saucer", "direction": "bullish"}
                },
                "ta_analysis": {
                    "confidence": 10,
                    "ta_data": {
                        "awesome-oscillator-buy-price": [
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            63.2734413147,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            71.6399993896,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                        ],
                        "awesome-oscillator-sell-price": [
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            62.9291496277,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            68.8000030518,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                            None,
                        ],
                        "awesome-oscillator-signal": [
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            -1,
                            0,
                            0,
                            0,
                            0,
                            0,
                            1,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            -1,
                            1,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                        ],
                        "awesome-oscillator": [
                            0,
                            0,
                            0,
                            0,
                            0,
                            0.30364757347500415,
                            0.5776480047871431,
                            0.8760352371875015,
                            1.396938138985547,
                            1.6621710592200003,
                            2.14792011635182,
                            2.701266842905831,
                            2.7708246941830907,
                            2.3957069270435625,
                            1.8572697711666706,
                            1.3129747570718777,
                            0.6349154420652852,
                            -0.035759303873881265,
                            -0.30513322033630885,
                            -0.2689795690449941,
                            -0.11813432261953238,
                            -0.04368842438181275,
                            -0.008524043846520613,
                            0.3361236165745751,
                            1.1023113669319997,
                            1.760787250514234,
                            2.229722900230378,
                            2.871398381752144,
                            3.2944964104258574,
                            3.2290228185350003,
                            2.84118788524097,
                            2.7181220741356213,
                            2.224543945019988,
                            2.168848528773239,
                            2.107473672497953,
                            2.340518684993235,
                            1.8109787582785373,
                            1.721709072753839,
                            1.8110481072808682,
                            2.02552209066441,
                            2.734254062569704,
                            4.443154774544709,
                            5.490943298437358,
                            6.226962274540583,
                            6.37308247027822,
                            5.848068326313225,
                            5.197211489367348,
                            4.417222573902649,
                            2.9912743155538237,
                            1.741211168616445,
                            0.9866771662144203,
                            0.18721995677029213,
                            -0.1619118251011713,
                            0.5443362755532348,
                            1.7890140366717588,
                            2.7168365072691074,
                            3.815325894447625,
                            4.777351695287649,
                            5.277878647806773,
                            5.573781462806764,
                        ],
                    },
                },
                "graph_url": "http://s3-ap-southeast-2.amazonaws.com/mfers-graphs/-8643543188091677687.png",
            },
            {
                "symbol": "bhp",
                "date_from": "2022-01-01T04:16:13+10:00",
                "date_to": "2022-03-30T04:16:13+10:00",
                "resolution": "1d",
                "search_period": 20,
                "notify_method": "pushover",
                "notify_recipient": "some-pushover-app-1",
                "target_ta_confidence": 3,
                "ta_algo": {"stoch": None},
                "ta_analysis": {"confidence": 10, "ta_data": None},
                "graph_url": "Algo not implemented",
            },
            {
                "symbol": "bhp",
                "date_from": "2022-01-01T04:16:13+10:00",
                "date_to": "2022-03-30T04:16:13+10:00",
                "resolution": "1d",
                "search_period": 20,
                "notify_method": "pushover",
                "notify_recipient": "some-pushover-app-1",
                "target_ta_confidence": 3,
                "ta_algo": {"accumulation-distribution": None},
                "ta_analysis": {"confidence": 10, "ta_data": None},
                "graph_url": "Algo not implemented",
            },
        ],
    }
    lambda_handler(payload, None)
